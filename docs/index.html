<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Texas COVID-19 Hospital Resource Usage</title>
    <meta name="description" content="Regional COVID-19 hospital resource usage in Texas based on Department of State Health Services data.">
    <meta name="keywords" content="COVID-19, coronavirus, SARS-CoV-2, Texas, DSHS, TSA, D3, D3.js, Cases, Outbreak, Pandemic">
    <link rel="icon" type="image/png" href="favicon.png">
    <meta name="author" content="Colin Sullender">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:creator" content="@shiruken">
    <meta name="twitter:title" content="Texas COVID-19 Hospital Resource Usage">
    <meta name="twitter:description" content="Regional COVID-19 hospital resource usage in Texas based on Department of State Health Services data.">
    <meta name="twitter:image" content="https://covid-texas.csullender.com/social.png">
    
    <meta property="og:title" content="Texas COVID-19 Hospital Resource Usage">
    <meta property="og:description" content="Regional COVID-19 hospital resource usage in Texas based on Department of State Health Services data.">
    <meta property="og:image" content="https://covid-texas.csullender.com/social.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="628">
    <meta property="og:url" content="https://covid-texas.csullender.com/">
    <meta property="og:type" content="website">

    <meta name="viewport" content="width=1100">

    <style>
        body { 
            font-family: Arial, Helvetica, sans-serif;
        }

        a#badge {
            display: block;
            position: absolute;
            top: 10px;
            right: 10px;
            width: 150px;
            padding: 10px 5px 10px 50px;
            color: #000000;
            font-weight: bold;
            text-decoration: none;
            text-align: center;
            border: 1px solid #000000;
            border-radius: 10px;
            background: url(sars-cov-2.png) 10px no-repeat;
            background-size: 40px;
            transition-duration: 250ms;
        }
        
        a#badge:hover {
            color: #FFFFFF;
            background-color: #000000;
        }

        header {
            text-align: center;
        }

        header h1#title {
            margin-bottom: 5px;
        }

        h2#subtitle {
            font-size: 1em;
            color: #999;
            font-weight: normal;
            margin-top: 5px;
            min-height: 22px;
        }

        div#control {
            text-align: center;
            font-size: 1.2em;
            margin-top: 50px;
        }

        select#tsaSelect {
            font-size: 1em;
            padding: 3px;
            width: 320px;
        }

        div.container {
            width: 1100px;
            height: 450px;
            margin: 50px auto 75px auto;
        }

        div.container.stacked {
            height: 490px;
        }

        div.chart {
            float: left;
            width: 880px;
        }

        g.xAxis, g.yAxis {
            font-size: 0.9em;
        }

        g.yAxisGrid {
            color: #ccc;
        }

        text.chartTitle {
            font-size: 1.1em;
            font-weight: bold;
            text-anchor: middle;
        }

        .purple circle, circle.purple {
            fill: #7570B3;
        }

        .orange circle, circle.orange {
            fill: #D95F02;
        }

        .data path {
            fill: none;
            stroke-width: 4;
            stroke-linecap: round;
        }

        .purple path {
            stroke: #7570B3;
        }

        .orange path {
            stroke: #D95F02;
        }

        line.hover-line {
            stroke: #999999;
            stroke-width: 1px;
            stroke-dasharray: 4;
        }

        rect.overlay {
            fill: none;
            pointer-events: all;
        }

        .note line {
            stroke: #999999;
            stroke-width: 1px;
            stroke-dasharray: 2;
        }

        .warning text, .note-occupancy text {
            font-size: 0.8em;
            fill: #999999;
            white-space: pre;
        }

        .note-occupancy line {
            stroke: #666666;
            stroke-width: 2px;
            stroke-dasharray: 2;
        }

        .note-occupancy text {
            text-anchor: end;
        }

        .legend line {
            stroke: #000000;
            stroke-width: 4;
            stroke-linecap: round;
        }

        .warning rect {
            fill: #F2DEDE;
        }

        dt.warning {
            color: #999999;
            font-style: italic;
            padding-top: 20px;
        }

        div.data {
            float: right;
            width: 220px;
            padding-top: 40px;
        }

        div.data h4 {
            margin: 0px 20px;
            font-style: italic;
            font-weight: normal;
        }

        div.data h3 {
            font-size: 1em;
            font-weight: normal;
            margin: 20px 10px 10px 20px;
        }

        div.data h3 strong {
            font-size: 1.5em;
        }

        strong.bed-number {
            color: #7570B3;
        }

        strong.covid-number {
            color: #D95F02;
        }

        div.data dl {
            font-size: 0.9em;
            margin: 60px 10px 10px 20px;
        }

        div#data-bed-count dl {
            margin-top: 10px;
            margin-bottom: 80px;
        }

        div#data-case dl {
            margin-top: 10px;
            margin-bottom: 120px;
        }

        div.data dt {
            margin-top: 10px;
        }

        div.data dd {
            font-size: 1.1em;
            font-weight: bold;
            margin: 5px 0px;
        }

        footer {
            width: 900px;
            margin: 0px auto 30px auto;
            text-align: center;
            color: #999;
            clear: both;
        }

        p#links a, p#links a:visited {
            color: #999;
            text-decoration: none;
        }

        p#links a:hover, p#links a:active {
            border-bottom: 1px dotted #666666;
            color: #666666;
        }

        p#data-desc {
            font-size: 0.8em;
        }

        p#data-desc a, p#data-desc a:visited {
            color: #999999;
        }

        p#data-desc a:hover, p#data-desc a:active {
            color: #666666;
        }

        div.alert {
            padding: 15px 30px;
            margin: 20px auto;
            border: 1px solid transparent;
            border-radius: 4px;
            background-color: #f2dede;
            border-color: #ebccd1;
            color: #a94442;
        }

        div.alert, p#data-desc {
            max-height: 999999px;
        }

    </style>
</head>

<body>

    <a id="badge" href="https://covid.csullender.com/">Check out My COVID-19 Tracker</a>

    <header>
        <h1 id="title">Texas COVID-19 Hospital Resource Usage</h1>
        <h2 id="subtitle"></h2>
    </header>

    <div id="control">
        <label for="tsa">Select Location:</label>
        <select name="tsa" id="tsaSelect"></select>
    </div>
    <div class="container stacked">
        <div id="chart-case" class="chart"></div>
        <div id="data-case" class="data"></div>
    </div>
    <div class="container">
        <div id="chart-covid" class="chart"></div>
        <div id="data-covid" class="data"></div>
    </div>
    <div class="container stacked">
        <div id="chart-bed-count" class="chart"></div>
        <div id="data-bed-count" class="data"></div>
    </div>
    <div class="container">
        <div id="chart-hospital-beds" class="chart"></div>
        <div id="data-hospital-beds" class="data"></div>
    </div>
    <div class="container">
        <div id="chart-icu-beds" class="chart"></div>
        <div id="data-icu-beds" class="data"></div>
    </div>
    <footer>
        <p id="links">
            <a href="https://www.dshs.state.tx.us/coronavirus/additionaldata/" title="Link to Texas DSHS COVID-19 data">Data from Texas DSHS</a> 
            Â· 
            <a href="https://github.com/shiruken/covid-texas" title="Link to website source code on GitHub">View on GitHub</a>
        </p>
        <p id="data-desc">
            Hospital data <a href="https://txdshs.maps.arcgis.com/apps/opsdashboard/index.html#/0d8bdf9be927459d9cb11b9eaef6101f" title="View Texas DSHS COVID-19 Test and Hospital Dashboard">reported daily</a> by the Texas Department of Health State Services are used for all metrics. 
            Average staffed community hospital bed occupancy rate for Texas as reported by the National Center for Health Statistics</a> in <a href="https://www.cdc.gov/nchs/hus/contents2017.htm#Table_091" title="View Table 91 from report"><em>Health, United States, 2017</em></a>.
            The "Statewide Total" is manually calculated by aggregating values from all available <a href="https://www.dshs.texas.gov/emstraumasystems/etrarac.shtm" title="Link to Regional Advisory Council website">trauma service areas</a> (TSAs). 
            This aggregation is incomplete for bed counts prior to May 29, 2020, because of fragmented reporting from TSA-F (Paris) and TSA-R (Galveston). 
            All data is incomplete between July 23 to July 28 <a href="https://www.kxan.com/news/coronavirus/hospitalizations/18-of-texas-hospitals-arent-reporting-complete-data-dshs-says/" title="KXAN article about hospital reporting issues">due to a transition in hospital reporting</a> to comply with new federal requirements. 
            Manual curation was performed as necessary to avoid extreme graph values and are documented in the <a href="https://github.com/shiruken/covid-texas/blob/master/fetch.py" title="View fetch.py on GitHub">update script</a>.
        </p>
    </footer>

    <script src="https://d3js.org/d3.v5.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        
        const margin = {top: 30, right: 17, bottom: 30, left: 55},
            width = 880 - margin.left - margin.right,
            height = 450 - margin.top - margin.bottom;

        const n_sma = 7; // Simple Moving Average window size

        // Initialize charts
        createStackedChartFramework("#chart-case", "Cases", "Fatalities");
        createChartFramework("#chart-covid", "COVID-19 Inpatients", "COVID-19 ICU Inpatients");
        createStackedChartFramework("#chart-bed-count", "Staffed Inpatient Beds", "Total ICU Beds");
        createChartFramework("#chart-hospital-beds", "Inpatient Beds Used", "Used Beds with COVID-19");
        createChartFramework("#chart-icu-beds", "ICU Beds Used", "Used ICU Beds with COVID-19");

        // Add warnings to hospital resource chart
        d3.select("#chart-bed-count .stacked-top .warning").append("rect")
            .attr("height", height*0.5);
        d3.select("#chart-bed-count .stacked-top .warning").append("text")
            .text(" Data incomplete between July 23-28");
        d3.select("#chart-bed-count .stacked-bottom .warning").append("rect")
            .attr("height", height*0.5)
            .attr("transform", "translate(0, " + height*0.6 + ")")
        d3.select("#chart-bed-count .stacked-bottom .warning").append("text")
            .text(" Data incomplete between July 23-28");

        // Add warning to fatalities chart
        d3.select("#chart-case .stacked-bottom .warning").append("rect")
            .attr("height", height*0.5)
            .attr("transform", "translate(0, " + height*0.6 + ")")

        // Add average occupancy rate to hospital bed usage chart
        let note_occupancy = d3.select("#chart-hospital-beds g")
            .insert("g", "g.note + *")
            .classed("note-occupancy", true)
            .style("opacity", 0);
        note_occupancy.append("line")
            .attr("x1", 0)
            .attr("x2", width)
            .attr("y1", height * 0.4)
            .attr("y2", height * 0.4);
        note_occupancy.append("text")
            .attr("x", width)
            .attr("y", height * 0.385)
            .text("Average annual occupancy rate (60%)");

        const parseDate = d3.timeParse("%Y-%m-%d");
        const formatDate = d3.timeFormat("%B %e, %Y");
        const bisectDate = d3.bisector(d => d.date).left;

        d3.csv('data.csv', function(d) {

            let total_beds_available = parseValue(d.total_beds_available),
                total_beds_occupied = parseValue(d.total_beds_occupied),
                icu_beds_available = parseValue(d.icu_beds_available),
                icu_beds_occupied = parseValue(d.icu_beds_occupied),
                covid_inpatients = parseValue(d.covid_inpatients),
                covid_icu_inpatients = parseValue(d.covid_icu_inpatients),
                cases = parseValue(d.cases),
                cases_new = parseValue(d.cases_new),
                deaths = parseValue(d.deaths),
                deaths_new = parseValue(d.deaths_new),
                percent_total_covid = 100 * covid_inpatients / total_beds_occupied,
                percent_icu_covid = 100 * covid_icu_inpatients / icu_beds_occupied;

                if (!isFinite(percent_total_covid))
                    percent_total_covid = NaN;
                if (!isFinite(percent_icu_covid))
                    percent_icu_covid = NaN;

            return {
                tsa: d.tsa,
                location: d.location,
                date: parseDate(d['date']),
                total_beds_available: total_beds_available,
                total_beds_occupied: total_beds_occupied,
                total_beds: total_beds_occupied + total_beds_available,
                percent_total_occupied: 100 * total_beds_occupied / (total_beds_occupied + total_beds_available),
                icu_beds_available: icu_beds_available,
                icu_beds_occupied: icu_beds_occupied,
                icu_beds: icu_beds_occupied + icu_beds_available,
                percent_icu_occupied: 100 * icu_beds_occupied / (icu_beds_occupied + icu_beds_available),
                covid_inpatients: covid_inpatients,
                covid_icu_inpatients: covid_icu_inpatients,
                percent_total_covid: percent_total_covid,
                percent_icu_covid: percent_icu_covid,
                cases: cases,
                cases_new: cases_new,
                deaths: deaths,
                deaths_new: deaths_new
            };
        }).then(function(data_csv) {

            // Group data by TSA
            let data = d3.nest()
                .key(function(d) { return d.tsa; })
                .object(data_csv);
            let tsaIDs = Object.keys(data);
            tsaIDs.unshift(tsaIDs.splice(tsaIDs.indexOf("Total"), 1)[0]); // Statewide Total should be first

            // Compute simple moving average for all metrics by TSA
            tsaIDs.forEach(function(tsa) {
                for (let i = 0; i < data[tsa].length; i++) {
                    let slice = []
                    if (i < n_sma - 1)
                        slice = data[tsa].slice(0, i + 1);
                    else
                        slice = data[tsa].slice(i - (n_sma - 1), i + 1);

                    data[tsa][i].percent_total_occupied_sma = d3.mean(slice, d => d.percent_total_occupied);
                    data[tsa][i].percent_total_covid_sma = d3.mean(slice, d => d.percent_total_covid);
                    data[tsa][i].percent_icu_occupied_sma = d3.mean(slice, d => d.percent_icu_occupied);
                    data[tsa][i].percent_icu_covid_sma = d3.mean(slice, d => d.percent_icu_covid);
                    data[tsa][i].total_beds_sma = d3.mean(slice, d => d.total_beds);
                    data[tsa][i].icu_beds_sma = d3.mean(slice, d => d.icu_beds);
                    data[tsa][i].covid_inpatients_sma = d3.mean(slice, d => d.covid_inpatients);
                    data[tsa][i].covid_icu_inpatients_sma = d3.mean(slice, d => d.covid_icu_inpatients);
                    data[tsa][i].cases_new_sma = d3.mean(slice, d => d.cases_new);
                    data[tsa][i].deaths_new_sma = d3.mean(slice, d => d.deaths_new);
                }
            });

            // Check for query string parameter defining the default TSA
            let url = new URL(window.location.href);
            let TSA = url.searchParams.get("tsa");
            if (TSA === null || !tsaIDs.includes(TSA))
                TSA = "Total"; // Default to Statewide Total
            
            // Update subtitle
            let N = data[TSA].length - 1;
            d3.select("#subtitle").text("Trauma Service Area (TSA) data updated on "
                + formatDate(data[TSA][N].date));

            // Populate select menu and select default TSA
            d3.select("#tsaSelect")
                .selectAll('options')
                .data(tsaIDs)
                .enter()
                .append('option')
                .text(function (d) { 
                    if (d === "Total")
                        return data[d][0]['location'];
                    else
                        return data[d][0]['location'] + " (TSA-" + d + ")";               
                })
                .attr("value", function (d) { return d; })
                .property("selected", function(d){ return d === TSA; });

             // Initial display of charts
            updateCaseChart(data[TSA], 0);
            updateCOVIDChart(data[TSA], 0);
            updateCountChart(data[TSA], 0);
            updateTotalBedChart(data[TSA], 0);
            updateICUBedChart(data[TSA], 0);   

            // Populate details sections
            updateCaseDetails(data[TSA][N]);
            updateCOVIDDetails(data[TSA][N]);
            updateCountDetails(data[TSA][N]);
            updateTotalDetails(data[TSA][N]);
            updateICUDetails(data[TSA][N]);

            // Update charts when different TSA is selected
            d3.select("#tsaSelect").on("change", function(d) {
                TSA = d3.select(this).property("value");
                if (TSA === "Total")
                    window.history.replaceState(null, null, window.location.pathname);
                else
                    window.history.replaceState(null, null, "?tsa=" + TSA);

                // Update charts
                updateCaseChart(data[TSA], 500);
                updateCOVIDChart(data[TSA], 500);
                updateCountChart(data[TSA], 500);
                updateTotalBedChart(data[TSA], 500);
                updateICUBedChart(data[TSA], 500);

                // Update details
                let N = data[TSA].length - 1;
                updateCaseDetails(data[TSA][N]);
                updateCOVIDDetails(data[TSA][N]);
                updateCountDetails(data[TSA][N]);
                updateTotalDetails(data[TSA][N]);
                updateICUDetails(data[TSA][N]);

            });

        });

        // Missing values are parsed as NaN
        function parseValue(value) {
            if (value === "")
                return NaN;
            else
                return +value;
        }

        // Return padded date extent for given key
        function getDateExtent(data, key) {
            let max = d3.max(data, function(d) { return d.date; });
            let min = d3.min(data, function(d) {
                if (isNaN(d[key]))
                    return max;
                else
                    return d.date;
            });
            return [d3.timeDay.offset(min, -1), d3.timeDay.offset(max, 1)]
        }

        // Create basic chart structure under selector with given legend values     
        function createChartFramework(selector, legend1, legend2) {
            let svg = d3.select(selector)
                .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // Highlighted region delineating period of incomplete data
            let warning = svg.append("g")
                .classed("warning", true);
            warning.append("rect")
                .attr("height", height);
            warning.append("text")
                .attr("y", 20)
                .text(" Data incomplete between July 23-28");

            svg.append("g")
                .classed("yAxisGrid", true);

            svg.append("g")
                .classed("yAxis", true);

            svg.append("g")
                .classed("xAxis", true)
                .attr("transform", "translate(0, " + height + ")");

            // Vertical line during mouse-over
            svg.append("line")
                .classed("hover-line", true)
                .attr("y1", 0)
                .attr("y2", height)
                .style("opacity", 0);

            // Legend
            let legend = svg.append("g")
                .classed("legend", true)
                .attr("transform", "translate(20, 10)");
            legend.append("circle")
                .classed("purple", true)
                .attr("cx", 8)
                .attr("cy", 8)
                .attr("r", 4);
            legend.append("text")
                .attr("x", 25)
                .attr("y", 13)
                .text(legend1);
            legend.append("circle")
                .classed("orange", true)
                .attr("cx", 8)
                .attr("cy", 30)
                .attr("r", 4)
            legend.append("text")
                .attr("x", 25)
                .attr("y", 36)
                .text(legend2);
            legend.append("line")
                .attr("x1", 0)
                .attr("x2", 16)
                .attr("y1", 52)
                .attr("y2", 52);
            legend.append("text")
                .attr("x", 25)
                .attr("y", 58)
                .text("Moving Average (" + n_sma + "-day)");

            // Chart data elements
            svg.append("g")
                .classed("data", true)
                .classed("purple", true);
            svg.append("g")
                .classed("data", true)
                .classed("orange", true);

            // Focus indicators during mouseover
            svg.append("circle")
                .classed("focus", true)
                .classed("purple", true)
                .attr("r", 5)
                .style("opacity", 0);
            svg.append("circle")
                .classed("focus", true)
                .classed("orange", true)
                .attr("r", 5)
                .style("opacity", 0);

            svg.append("text")
                .classed("chartTitle", true)
                .attr("x", (width / 2))
                .attr("y", 0 - (margin.top / 2));

            // Overlay for handling comparison-view mouseover
            svg.append("rect")
                .classed("overlay", true)
                .attr("width", width)
                .attr("height", height);
        }

        // Create stacked chart structure under selector with given legend values     
        function createStackedChartFramework(selector, legend1, legend2) {
            let svg = d3.select(selector)
                .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height*1.1 + margin.top + margin.bottom)
                    .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            let g1 = svg.append("g").classed("stacked-top", true);
            let g2 = svg.append("g").classed("stacked-bottom", true);
    
            // Highlighted region delineating period of incomplete data
            let warning1 = g1.append("g")
                .classed("warning", true);
            let warning2 = g2.append("g")
                .classed("warning", true)

            g1.append("g")
                .classed("yAxisGrid", true)

            g2.append("g")
                .classed("yAxisGrid", true)

            g1.append("g")
                .classed("yAxis", true)

            g2.append("g")
                .classed("yAxis", true)

            g2.append("g")
                .classed("xAxis", true)
                .attr("transform", "translate(0, " + height*1.1 + ")");

            // Vertical line during mouse-over
            g1.append("line")
                .classed("hover-line", true)
                .attr("y1", 0)
                .attr("y2", height*0.5)
                .style("opacity", 0);

            g2.append("line")
                .classed("hover-line", true)
                .attr("y1", height*0.6)
                .attr("y2", height*1.1)
                .style("opacity", 0);

            // Legends
            let L1 = g1.append("g")
                .classed("legend", true)
                .attr("transform", "translate(20, 15)");
            L1.append("circle")
                .classed("purple", true)
                .attr("cx", 8)
                .attr("cy", 8)
                .attr("r", 4);
            L1.append("text")
                .attr("x", 25)
                .attr("y", 13)
                .text(legend1);
            L1.append("line")
                .attr("x1", 0)
                .attr("x2", 16)
                .attr("y1", 30)
                .attr("y2", 30)
                .style("stroke", "7570B3");
            L1.append("text")
                .attr("x", 25)
                .attr("y", 36)
                .text("Moving Average (" + n_sma + "-day)");

            let L2 = g2.append("g")
                .classed("legend", true)
                .attr("transform", "translate(20, 250)");
            L2.append("circle")
                .classed("orange", true)
                .attr("cx", 8)
                .attr("cy", 8)
                .attr("r", 4)
            L2.append("text")
                .attr("x", 25)
                .attr("y", 13)
                .text(legend2);
            L2.append("line")
                .attr("x1", 0)
                .attr("x2", 16)
                .attr("y1", 30)
                .attr("y2", 30)
                .style("stroke", "D95F02");
            L2.append("text")
                .attr("x", 25)
                .attr("y", 36)
                .text("Moving Average (" + n_sma + "-day)");

            // Chart data elements
            g1.append("g")
                .classed("data", true)
                .classed("purple", true)
            g2.append("g")
                .classed("data", true)
                .classed("orange", true);

            // Focus indicators during mouseover
            g1.append("circle")
                .classed("focus", true)
                .classed("purple", true)
                .attr("r", 5)
                .style("opacity", 0);
            g2.append("circle")
                .classed("focus", true)
                .classed("orange", true)
                .attr("r", 5)
                .style("opacity", 0);

            g1.append("text")
                .classed("chartTitle", true)
                .attr("x", (width / 2))
                .attr("y", 0 - (margin.top / 2));

            // Overlay for handling comparison-view mouseover
            svg.append("rect")
                .classed("overlay", true)
                .attr("width", width)
                .attr("height", height*1.1);
        }

        // Generate the total hospital bed chart
        function updateTotalBedChart(data, duration) {
            let chart = d3.select("#chart-hospital-beds");
            let tsa = data[0].tsa;

            // Update x-axis
            let xExtent = getDateExtent(data, "percent_total_occupied");
            let xScale = d3.scaleTime()
                .domain(xExtent)
                .range([0, width]);
            chart.select(".xAxis")
                .transition()
                .duration(duration)
                .call(d3.axisBottom(xScale).ticks(d3.timeWeek.every(3)));

            // Update y-axis
            let yScale = d3.scaleLinear()
                .domain([0, 100])
                .range([height, 0]);
            let yAxis = d3.axisLeft(yScale)
                .ticks(5)
                .tickFormat(d => d + "%");
            chart.select(".yAxis")
                .call(yAxis);
            let yAxisGrid = d3.axisLeft(yScale)
                .ticks(5)
                .tickFormat('')
                .tickSize(-width);
            chart.select(".yAxisGrid")
                .call(yAxisGrid);

            // Total Hospital Bed Usage
            let filtered = filterData(data, "percent_total_occupied", xScale, yScale);
            drawScatterPlot("#chart-hospital-beds .data.purple", filtered, duration);

            // Total Hospital Bed Usage - Simple Moving Average
            filtered = filterData(data, "percent_total_occupied_sma", xScale, yScale);
            drawLinePlot("#chart-hospital-beds .data.purple", filtered, duration);

            // Total Hospital Bed COVID-19 Usage
            filtered = filterData(data, "percent_total_covid", xScale, yScale);
            drawScatterPlot("#chart-hospital-beds .data.orange", filtered, duration);

            // Total Hospital Bed COVID-19 Usage - Simple Moving Average
            filtered = filterData(data, "percent_total_covid_sma", xScale, yScale);
            drawLinePlot("#chart-hospital-beds .data.orange", filtered, duration);

            // Update overlay
            updateOverlay("#chart-hospital-beds", data, "percent_total_occupied", "percent_total_covid",
                            xExtent, xScale, yScale, updateTotalDetails);
                
            // Update warning region
            let x_warning = xScale(parseDate('2020-07-23'));
            let width_warning = xScale(parseDate('2020-07-28')) - xScale(parseDate('2020-07-23'));
            updateWarning("#chart-hospital-beds", tsa, x_warning, width_warning, duration);

            // Toggle visibility of average hospital occupancy note
            chart.select(".note-occupancy")
                .transition()
                .duration(duration)
                .style("opacity", tsa === "Total" ? 1 : 0);

            // Update title
            let title = "";
            if (tsa === "Total")
                title = "Statewide Hospital Bed Usage";
            else
                title = "Hospital Bed Usage in TSA-" + tsa + " (" + data[0].location + ")";
            chart.select(".chartTitle").text(title);
        }

        // Generate the ICU bed chart
        function updateICUBedChart(data, duration) {
            let chart = d3.select("#chart-icu-beds");
            let tsa = data[0].tsa;

            // Update x-axis
            let xExtent = getDateExtent(data, "percent_icu_occupied");
            let xScale = d3.scaleTime()
                .domain(xExtent)
                .range([0, width]);
            chart.select(".xAxis")
                .transition()
                .duration(duration)
                .call(d3.axisBottom(xScale).ticks(d3.timeWeek.every(3)));

            // Update y-axis
            let yScale = d3.scaleLinear()
                .domain([0, 100])
                .range([height, 0]);
            let yAxis = d3.axisLeft(yScale)
                .ticks(5)
                .tickFormat(d => d + "%");
            chart.select(".yAxis")
                .call(yAxis);
            let yAxisGrid = d3.axisLeft(yScale)
                .ticks(5)
                .tickFormat('')
                .tickSize(-width);
            chart.select(".yAxisGrid")
                .call(yAxisGrid);

            // Total Hospital Bed Usage
            let filtered = filterData(data, "percent_icu_occupied", xScale, yScale);
            drawScatterPlot("#chart-icu-beds .data.purple", filtered, duration);

            // Total Hospital Bed Usage - Simple Moving Average
            filtered = filterData(data, "percent_icu_occupied_sma", xScale, yScale);
            drawLinePlot("#chart-icu-beds .data.purple", filtered, duration);

            // Total Hospital Bed COVID-19 Usage
            filtered = filterData(data, "percent_icu_covid", xScale, yScale);
            drawScatterPlot("#chart-icu-beds .data.orange", filtered, duration);

            // Total Hospital Bed COVID-19 Usage - Simple Moving Average
            filtered = filterData(data, "percent_icu_covid_sma", xScale, yScale);
            drawLinePlot("#chart-icu-beds .data.orange", filtered, duration);

            // Update overlay
            updateOverlay("#chart-icu-beds", data, "percent_icu_occupied", "percent_icu_covid",
                            xExtent, xScale, yScale, updateICUDetails);

            // Update warning region
            let x_warning = xScale(parseDate('2020-07-23'));
            let width_warning = xScale(parseDate('2020-07-28')) - xScale(parseDate('2020-07-23'));
            updateWarning("#chart-icu-beds", tsa, x_warning, width_warning, duration);

            // Update title
            let title = "";
            if (tsa === "Total")
                title = "Statewide ICU Bed Usage";
            else
                title = "ICU Bed Usage in TSA-" + tsa + " (" + data[0].location + ")";
            chart.select(".chartTitle").text(title);

            moveICULegend(tsa, duration);
        }

        // Generate the bed count chart
        function updateCountChart(data, duration) {
            let chart = d3.select("#chart-bed-count");
            let tsa = data[0].tsa;

            // Update x-axis
            let xExtent = getDateExtent(data, "total_beds");
            let xScale = d3.scaleTime()
                .domain(xExtent)
                .range([0, width]);
            chart.select(".xAxis")
                .transition()
                .duration(duration)
                .call(d3.axisBottom(xScale).ticks(d3.timeWeek.every(3)));

            // Update first chart y-axis
            let yMax1 = d3.max(data, d => d.total_beds);
            let yScale1 = d3.scaleLinear()
                .domain([0, yMax1]).nice(4)
                .range([height*0.5, 0]);
            let yAxis1 = d3.axisLeft(yScale1)
                .ticks(3);
            chart.select(".stacked-top .yAxis")
                .transition()
                .duration(duration)
                .call(yAxis1);
            let yAxisGrid1 = d3.axisLeft(yScale1)
                .ticks(3)
                .tickFormat('')
                .tickSize(-width);
            chart.select(".stacked-top .yAxisGrid")
                .transition()
                .duration(duration)
                .call(yAxisGrid1);

            // Update second chart y-axis
            let yMax2 = d3.max(data, d => d.icu_beds);
            let yScale2 = d3.scaleLinear()
                .domain([0, yMax2]).nice(4)
                .range([height*1.1, height*0.6]);
            let yAxis2 = d3.axisLeft(yScale2)
                .ticks(4);
            chart.select(".stacked-bottom .yAxis")
                .transition()
                .duration(duration)
                .call(yAxis2);
            let yAxisGrid2 = d3.axisLeft(yScale2)
                .ticks(4)
                .tickFormat('')
                .tickSize(-width);
            chart.select(".stacked-bottom .yAxisGrid")
                .transition()
                .duration(duration)
                .call(yAxisGrid2);

            // Total Staffed Hospital Bed Count
            let filtered = filterData(data, "total_beds", xScale, yScale1);
            drawScatterPlot("#chart-bed-count .data.purple", filtered, duration);

            // Total Staffed Hospital Bed Count - Simple Moving Average
            filtered = filterData(data, "total_beds_sma", xScale, yScale1);
            drawLinePlot("#chart-bed-count .data.purple", filtered, duration);

            // Total ICU Bed Count
            filtered = filterData(data, "icu_beds", xScale, yScale2);
            drawScatterPlot("#chart-bed-count .data.orange", filtered, duration);

            // Total ICU Bed Count - Simple Moving Average
            filtered = filterData(data, "icu_beds_sma", xScale, yScale2);
            drawLinePlot("#chart-bed-count .data.orange", filtered, duration);

            // Update overlay
            updateStackedOverlay("#chart-bed-count", data, "total_beds", "icu_beds",
                xExtent, xScale, yScale1, yScale2, updateCountDetails);

            // Update warning region
            let x_warning = xScale(parseDate('2020-07-23'));
            let width_warning = xScale(parseDate('2020-07-28')) - xScale(parseDate('2020-07-23'));
            updateWarning("#chart-bed-count .stacked-top", tsa, x_warning, width_warning, duration);
            updateWarning("#chart-bed-count .stacked-bottom", tsa, x_warning, width_warning, duration);

            // Update title
            let title = "";
            if (tsa === "Total")
                title = "Statewide Total Hospital Resources";
            else
                title = "Total Hospital Resources in TSA-" + tsa + " (" + data[0].location + ")";
            chart.select(".chartTitle").text(title);

            moveCountLegend(tsa, duration);
        }

        // Generate the COVID-19 inpatients chart
        function updateCOVIDChart(data, duration) {
            let chart = d3.select("#chart-covid");
            let tsa = data[0].tsa;

            // Update x-axis
            let xExtent = getDateExtent(data, "covid_inpatients");
            let xScale = d3.scaleTime()
                .domain(xExtent)
                .range([0, width]);
            chart.select(".xAxis")
                .transition()
                .duration(duration)
                .call(d3.axisBottom(xScale).ticks(d3.timeWeek.every(3)));

            // Update y-axis
            let yMax = d3.max(data, d => d.covid_inpatients);
            let yScale = d3.scaleLinear()
                .domain([0, yMax]).nice(4)
                .range([height, 0]);
            let yAxis = d3.axisLeft(yScale)
                .ticks(4);
            chart.select(".yAxis")
                .transition()
                .duration(duration)
                .call(yAxis);
            let yAxisGrid = d3.axisLeft(yScale)
                .ticks(4)
                .tickFormat('')
                .tickSize(-width);
            chart.select(".yAxisGrid")
                .transition()
                .duration(duration)
                .call(yAxisGrid);

            // Total COVID-19 Inpatients
            let filtered = filterData(data, "covid_inpatients", xScale, yScale);
            drawScatterPlot("#chart-covid .data.purple", filtered, duration);

            // Total COVID-19 Inpatients - Simple Moving Average
            filtered = filterData(data, "covid_inpatients_sma", xScale, yScale);
            drawLinePlot("#chart-covid .data.purple", filtered, duration);

            // Total COVID-19 ICU Inpatients
            filtered = filterData(data, "covid_icu_inpatients", xScale, yScale);
            drawScatterPlot("#chart-covid .data.orange", filtered, duration);

            // Total COVID-19 ICU Inpatients - Simple Moving Average
            filtered = filterData(data, "covid_icu_inpatients_sma", xScale, yScale);
            drawLinePlot("#chart-covid .data.orange", filtered, duration);

            // Update overlay
            updateOverlay("#chart-covid", data, "covid_inpatients", "covid_icu_inpatients",
                            xExtent, xScale, yScale, updateCOVIDDetails);

            // Update warning region
            let x_warning = xScale(parseDate('2020-07-23'));
            let width_warning = xScale(parseDate('2020-07-28')) - xScale(parseDate('2020-07-23'));
            updateWarning("#chart-covid", tsa, x_warning, width_warning, duration);

            // Update title
            let title = "";
            if (tsa === "Total")
                title = "Statewide COVID-19 Hospitalizations";
            else
                title = "COVID-19 Hospitalizations in TSA-" + tsa + " (" + data[0].location + ")";
            chart.select(".chartTitle").text(title);

            moveCOVIDLegend(tsa, duration);
        }

        // Generate the COVID-19 case chart
        function updateCaseChart(data, duration) {
            let chart = d3.select("#chart-case");
            let tsa = data[0].tsa;

            // Update x-axis
            let xExtent = getDateExtent(data, "cases_new");
            let xScale = d3.scaleTime()
                .domain(xExtent)
                .range([0, width]);
            chart.select(".xAxis")
                .transition()
                .duration(duration)
                .call(d3.axisBottom(xScale).ticks(d3.timeWeek.every(3)));

            // Update first chart y-axis
            let yMax1 = d3.max(data, d => d.cases_new);
            let yScale1 = d3.scaleLinear()
                .domain([0, yMax1]).nice(4)
                .range([height*0.5, 0]);
            let yAxis1 = d3.axisLeft(yScale1)
                .ticks(3);
            chart.select(".stacked-top .yAxis")
                .transition()
                .duration(duration)
                .call(yAxis1);
            let yAxisGrid1 = d3.axisLeft(yScale1)
                .ticks(3)
                .tickFormat('')
                .tickSize(-width);
            chart.select(".stacked-top .yAxisGrid")
                .transition()
                .duration(duration)
                .call(yAxisGrid1);

            // Update second chart y-axis
            let yMax2 = d3.max(data, d => d.deaths_new);
            let yScale2 = d3.scaleLinear()
                .domain([0, yMax2]).nice(4)
                .range([height*1.1, height*0.6]);
            let yAxis2 = d3.axisLeft(yScale2)
                .ticks(3);
            chart.select(".stacked-bottom .yAxis")
                .transition()
                .duration(duration)
                .call(yAxis2);
            let yAxisGrid2 = d3.axisLeft(yScale2)
                .ticks(3)
                .tickFormat('')
                .tickSize(-width);
            chart.select(".stacked-bottom .yAxisGrid")
                .transition()
                .duration(duration)
                .call(yAxisGrid2);

            // Daily New COVID-19 Cases
            let filtered = filterData(data, "cases_new", xScale, yScale1);
            drawScatterPlot("#chart-case .data.purple", filtered, duration);

            // Daily New COVID-19 Cases - Simple Moving Average
            filtered = filterData(data, "cases_new_sma", xScale, yScale1);
            drawLinePlot("#chart-case .data.purple", filtered, duration);

            // Daily New COVID-19 Deaths
            filtered = filterData(data, "deaths_new", xScale, yScale2);
            drawScatterPlot("#chart-case .data.orange", filtered, duration);

            // Daily New COVID-19 Deaths - Simple Moving Average
            filtered = filterData(data.slice(0, data.length - 20), "deaths_new_sma", xScale, yScale2);
            drawLinePlot("#chart-case .data.orange", filtered, duration);

            // Update overlay
            updateStackedOverlay("#chart-case", data, "cases_new", "deaths_new",
                xExtent, xScale, yScale1, yScale2, updateCaseDetails);

            // Update warning region
            let last_date = d3.max(data, d => d.date);
            let warning_stop = xScale(last_date);
            let warning_start = xScale(d3.timeDay.offset(last_date, -20));
            chart.select(".stacked-bottom .warning rect")
                .attr("height", height*0.5)
                .attr("transform", "translate(0, " + height*0.6 + ")")
                .transition()
                .duration(duration)
                .attr("x", warning_start)
                .attr("width", warning_stop - warning_start);

            // Update title
            let title = "";
            if (tsa === "Total")
                title = "Statewide Daily COVID-19 Cases and Fatalities";
            else
                title = "Daily COVID-19 Cases and Fatalities in TSA-" + tsa + " (" + data[0].location + ")";
            chart.select(".chartTitle").text(title);

            moveCaseLegend(tsa, duration);
        }


        // Filter and format data into (x,y) for use with plot functions
        function filterData(data, yProp, xScale, yScale) {
            let filtered = data.filter(d => !isNaN(d[yProp]))
                .map(d => ({ 
                    x: xScale(d["date"]), 
                    y: yScale(d[yProp])
                }));
            return filtered;
        }

        // Draw and update scatter plot of daily values
        function drawScatterPlot(selector, data, duration) {
            let circles = d3.select(selector)
                .selectAll("circle")
                .data(data);

            circles.enter()
                .append("circle")
                    .attr("r", 3)
                    .attr("cx", width)
                .merge(circles)
                    .transition()
                    .duration(duration)
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);

            circles.exit().remove();
        }

        // Draw and update line plot of simple moving average
        function drawLinePlot(selector, data, duration) {
            let path = d3.select(selector).select("path");

            if (path.empty())
                path = d3.select(selector).append("path");

            path.datum(data)
                .attr("d", d3.line()
                    .x(d => d.x)
                    .y(d => d.y)
                );

            // Transition by drawing path from left to right
            let length = path.node().getTotalLength();
            path
                .attr("stroke-dasharray", length + " " + length)
                .attr("stroke-dashoffset", length)
                .transition()
                .ease(d3.easeCubicIn)
                .duration(duration)
                .attr("stroke-dashoffset", 0);
        }

        // Draw and update overlay for controlling mouseover functionality
        // with highlighted data points and vertical hover line
        function updateOverlay(selector, data, yProp1, yProp2, xExtent, xScale, yScale, updateDetailFnc) {
            let overlay = d3.select(selector).select(".overlay");
            let focus_purple = d3.select(selector).select("circle.focus.purple");
            let focus_orange = d3.select(selector).select("circle.focus.orange");
            let hover_line = d3.select(selector).select(".hover-line");

            overlay.datum(data)
                .on("mouseover", function() { 
                    focus_purple.style("opacity", 1);
                    focus_orange.style("opacity", 1);
                    hover_line.style("opacity", 1);
                })
                .on("mouseout", function(d) {
                    focus_purple.style("opacity", 0);
                    focus_orange.style("opacity", 0);
                    hover_line.style("opacity", 0);
                    updateDetailFnc(d[d.length - 1]);
                })
                .on('mousemove', function(d) { 
                    let offset = bisectDate(d, xExtent[0]);
                    let x0 = xScale.invert(d3.mouse(this)[0]);
                    let i = bisectDate(d, x0, offset, d.length - 1);

                    if (isNaN(d[i][yProp1]))
                        focus_purple.style("opacity", 0);
                    else
                        focus_purple
                            .style("opacity", 1)
                            .attr("cx", xScale(d[i]["date"]))
                            .attr("cy", yScale(d[i][yProp1]));                        

                    if (isNaN(d[i][yProp2]))
                        focus_orange.style("opacity", 0);
                    else
                        focus_orange
                            .style("opacity", 1)
                            .attr("cx", xScale(d[i]["date"]))
                            .attr("cy", yScale(d[i][yProp2]));
                            
                    if (!isNaN(d[i][yProp1]) || !isNaN(d[i][yProp2])) {
                        hover_line
                            .attr("x1", xScale(d[i]["date"]))
                            .attr("x2", xScale(d[i]["date"]));
                        updateDetailFnc(d[i]);
                    }
                });
        }

        // Draw and update overlay on stacked charts for controlling mouseover 
        // functionality with highlighted data points and vertical hover line
        function updateStackedOverlay(selector, data, yProp1, yProp2, xExtent, xScale, yScale1, yScale2, updateDetailFnc) {
            let overlay = d3.select(selector).select(".overlay");
            let focus_purple = d3.select(selector).select("circle.focus.purple");
            let focus_orange = d3.select(selector).select("circle.focus.orange");
            let hover_line1 = d3.select(selector).select(".stacked-top .hover-line");
            let hover_line2 = d3.select(selector).select(".stacked-bottom .hover-line");

            overlay.datum(data)
                .on("mouseover", function() { 
                    focus_purple.style("opacity", 1);
                    focus_orange.style("opacity", 1);
                    hover_line1.style("opacity", 1);
                    hover_line2.style("opacity", 1);
                })
                .on("mouseout", function(d) {
                    focus_purple.style("opacity", 0);
                    focus_orange.style("opacity", 0);
                    hover_line1.style("opacity", 0);
                    hover_line2.style("opacity", 0);
                    updateDetailFnc(d[d.length - 1]);
                })
                .on('mousemove', function(d) { 
                    let offset = bisectDate(d, xExtent[0]);
                    let x0 = xScale.invert(d3.mouse(this)[0]);
                    let i = bisectDate(d, x0, offset, d.length - 1);

                    if (isNaN(d[i][yProp1]))
                        focus_purple.style("opacity", 0);
                    else
                        focus_purple
                            .style("opacity", 1)
                            .attr("cx", xScale(d[i]["date"]))
                            .attr("cy", yScale1(d[i][yProp1]));                        

                    if (isNaN(d[i][yProp2]))
                        focus_orange.style("opacity", 0);
                    else
                        focus_orange
                            .style("opacity", 1)
                            .attr("cx", xScale(d[i]["date"]))
                            .attr("cy", yScale2(d[i][yProp2]));
                            
                    if (!isNaN(d[i][yProp1]) || !isNaN(d[i][yProp2])) {
                        hover_line1
                            .attr("x1", xScale(d[i]["date"]))
                            .attr("x2", xScale(d[i]["date"]));
                        hover_line2
                            .attr("x1", xScale(d[i]["date"]))
                            .attr("x2", xScale(d[i]["date"]));
                        updateDetailFnc(d[i]);
                    }
                });
        }

        // Draw and update the position of the highlighted region 
        // delineating the period of incomplete data between July 23-28
        function updateWarning(selector, tsa, x, width, duration) {
            let warning = d3.select(selector).select(".warning");

            warning.select("rect")
                .transition()
                .duration(duration)
                .attr("x", x)
                .attr("width", width);
                
            let y = 20;
            if (selector === "#chart-icu-beds")
                if (["A", "B", "D", "E", "F", "G", "I", "M", "N", "P", "Q", "R", "T", "U", "V"].includes(tsa))
                    y = height - 20;
            
            if (selector === "#chart-bed-count .stacked-top") 
                y = height*0.5 - 20;

            if (selector === "#chart-bed-count .stacked-bottom") 
                y = height*1.1 - 15;

            if (selector === "#chart-hospital-beds")
                if (["T"].includes(tsa))
                        y = height - 20;

            if (selector === "#chart-covid")
                if (["F"].includes(tsa))
                        y = height - 20;

            warning.select("text")
                .transition()
                .duration(duration)
                .attr("x", x + width)
                .attr("y", y);
        }

        // Format valid numbers to local string
        function formatNumber(value) {
            if (isNaN(value))
                return "NA";
            else
                return value.toLocaleString();
        }

        // Format valid numbers to local string with percent sign
        function formatPercent(value) {
            let options = {minimumFractionDigits: 0, maximumFractionDigits: 0};
            if (isNaN(value))
                return "NA";
            else
                return value.toLocaleString(undefined, options) + "%";
        }

        // Update Total Hospital Bed details
        function updateTotalDetails(data) {
            d3.select("#data-hospital-beds").html("" +
                "<h4>" + formatDate(data.date) + "</h4>" +
                "<h3>" +
                    "<strong class='bed-number'>" + formatPercent(data.percent_total_occupied) + "</strong> of beds used" + 
                "</h3>" +
                "<h3>" + 
                    "<strong class='covid-number'>" + formatPercent(data.percent_total_covid) + "</strong> of used beds have COVID-19 patients" +
                "</h3>" + 
                "<dl>" +
                    "<dt>Staffed Hospital Beds</dt>" +
                    "<dd>" + formatNumber(data.total_beds) + "</dd>" +
                    "<dt>Occupied Hospital Beds</dt>" +
                    "<dd>" + formatNumber(data.total_beds_occupied) + "</dd>" +
                    "<dt>Available Hospital Beds</dt>" +
                    "<dd>" + formatNumber(data.total_beds_available) + "</dd>" +
                    "<dt>COVID-19 Patients</dt>" +
                    "<dd>" + formatNumber(data.covid_inpatients) + "</dd>" +
                "</dl>"
            );
        }

        // Update ICU Bed details
        function updateICUDetails(data) {
            d3.select("#data-icu-beds").html("" +
                "<h4>" + formatDate(data.date) + "</h4>" +
                "<h3>" +
                    "<strong class='bed-number'>" + formatPercent(data.percent_icu_occupied) + "</strong> of ICU beds used" + 
                "</h3>" +
                "<h3>" + 
                    "<strong class='covid-number'>" + formatPercent(data.percent_icu_covid) + "</strong> of used ICU beds have COVID-19 patients" +
                "</h3>" + 
                "<dl>" +
                    "<dt>Total ICU Beds</dt>" +
                    "<dd>" + formatNumber(data.icu_beds) + "</dd>" +
                    "<dt>Occupied ICU Beds</dt>" +
                    "<dd>" + formatNumber(data.icu_beds_occupied) + "</dd>" +
                    "<dt>Available ICU Beds</dt>" +
                    "<dd>" + formatNumber(data.icu_beds_available) + "</dd>" +
                    "<dt>COVID-19 ICU Patients</dt>" +
                    "<dd>" + formatNumber(data.covid_icu_inpatients) + "</dd>" +
                "</dl>"
            );
        }

        // Update Bed Count details
        function updateCountDetails(data) {
            d3.select("#data-bed-count").html("" +
                "<h4>" + formatDate(data.date) + "</h4>" +
                "<h3>" +
                    "<strong class='bed-number'>" + formatNumber(data.total_beds) + "</strong> staffed beds" + 
                "</h3>" +
                "<dl>" +
                    "<dt>Occupied</dt>" +
                    "<dd>" + formatNumber(data.total_beds_occupied) + "</dd>" +
                    "<dt>Available</dt>" +
                    "<dd>" + formatNumber(data.total_beds_available) + "</dd>" +
                "</dl>" +
                "<h3>" + 
                    "<strong class='covid-number'>" + formatNumber(data.icu_beds) + "</strong> total ICU beds" +
                "</h3>" + 
                "<dl>" +
                    "<dt>Occupied</dt>" +
                    "<dd>" + formatNumber(data.icu_beds_occupied) + "</dd>" +
                    "<dt>Available</dt>" +
                    "<dd>" + formatNumber(data.icu_beds_available) + "</dd>" +
                "</dl>"
            );
        }

        // Update COVID-19 hospitalization details
        function updateCOVIDDetails(data) {
            d3.select("#data-covid").html("" +
                "<h4>" + formatDate(data.date) + "</h4>" +
                "<h3>" +
                    "<strong class='bed-number'>" + formatNumber(data.covid_inpatients) + "</strong> COVID-19 inpatients" + 
                "</h3>" +
                "<h3>" + 
                    "<strong class='covid-number'>" + formatNumber(data.covid_icu_inpatients) + "</strong> COVID-19 ICU inpatients" +
                "</h3>"
            );
        }

        // Update case and death details
        function updateCaseDetails(data) {
            d3.select("#data-case").html("" +
                "<h4>" + formatDate(data.date) + "</h4>" +
                "<h3>" +
                    "<strong class='bed-number'>" + formatNumber(data.cases_new) + "</strong> daily cases" + 
                "</h3>" +
                "<dl>" +
                    "<dt>Cumulative Cases</dt>" +
                    "<dd>" + formatNumber(data.cases) + "</dd>" +
                "</dl>" +
                "<h3>" + 
                    "<strong class='covid-number'>" + formatNumber(data.deaths_new) + "</strong> daily fatalities" +
                "</h3>" + 
                "<dl>" +
                    "<dt>Cumulative Fatalities</dt>" +
                    "<dd>" + formatNumber(data.deaths) + "</dd>" +
                    "<dt class='warning'>Data incomplete over past three weeks as fatalities are reported</dt>" +
                "</dl>"

            );
        }

        // Position ICU chart legend based on currently selected TSA
        function moveICULegend(TSA,duration) {
            let tform = "translate(20, 10)";

            if (["R"].includes(TSA))
                tform = "translate(20, 85)";
                
            if (["G", "I", "L", "Q", "T", "U"].includes(TSA))
                tform = "translate(20, 165)";

            if (["M", "V"].includes(TSA))
                tform = "translate(20, 245)";

            if(TSA == "H")
                tform = "translate(260, 320)";

            d3.select("#chart-icu-beds g.legend")
                .transition()
                .duration(duration)
                .attr("transform", tform);
        }

        // Position count chart legend based on currently selected TSA
        function moveCountLegend(TSA,duration) {

            // Legend 1
            let tform1 = "translate(20, 10)";

            if (["B", "F", "H", "J", "K", "L", "Q", "V", "Total"].includes(TSA))
                tform1 = "translate(20, 5)";

            if (["C", "U"].includes(TSA))
                tform1 = "translate(20, 15)";

            if (["D", "I", "R", "T"].includes(TSA))
                tform1 = "translate(20, 135)";

            if (["A", "G", "N", "O"].includes(TSA))
                tform1 = "translate(20, 145)";

            if (["E", "M", "P", "S"].includes(TSA))
                tform1 = "translate(20, 150)";

            d3.select("#chart-bed-count .stacked-top .legend")
                .transition()
                .duration(duration)
                .attr("transform", tform1);

            // Legend 2
            let tform2 = "translate(20, 250)";

            if (["H", "M", "U", "Total"].includes(TSA))
                tform2 = "translate(20, 235)";

            if (["C", "D", "J", "R", "V"].includes(TSA))
                tform2 = "translate(20, 240)";

            if (["A", "F", "I", "K", "Q"].includes(TSA))
                tform2 = "translate(20, 245)";

            if (["G"].includes(TSA))
                tform2 = "translate(20, 360)";

            if (["B", "E", "N", "S"].includes(TSA))
                tform2 = "translate(20, 372)";

            if (["O", "P", "T"].includes(TSA))
                tform2 = "translate(20, 378)";

            if (["L"].includes(TSA))
                tform2 = "translate(20, 385)";

            d3.select("#chart-bed-count .stacked-bottom .legend")
                .transition()
                .duration(duration)
                .attr("transform", tform2);
        }

        // Position COVID-19 chart legend based on currently selected TSA
        function moveCOVIDLegend(TSA,duration) {
            let tform = "translate(20, 10)";

            if (["I", "K", "Total"].includes(TSA))
                tform = "translate(20, 2)";

            if (["C", "D", "E", "F", "J", "L", "P", "S", "V"].includes(TSA))
                tform = "translate(20, 20)";

            if (["H", "G", "O", "M", "Q", "R", "T", "U"].includes(TSA))
                tform = "translate(20, 30)";

            d3.select("#chart-covid g.legend")
                .transition()
                .duration(duration)
                .attr("transform", tform);
        }

        // Position case/fatality chart legend based on currently selected TSA
        function moveCaseLegend(TSA,duration) {

            // Legend 1
            let tform1 = "translate(20, 10)";

            if (["D", "G", "I", "N", "O", "Q", "U", "V", "Total"].includes(TSA))
                tform1 = "translate(20, 5)";

            if (["A", "B", "C", "E", "R"].includes(TSA))
                tform1 = "translate(20, 15)";

            if (["F", "H", "K", "L", "M", "P", "S"].includes(TSA))
                tform1 = "translate(20, 20)";

            if(["J", "T"].includes(TSA))
                tform1 = "translate(20, 30)";

            d3.select("#chart-case .stacked-top .legend")
                .transition()
                .duration(duration)
                .attr("transform", tform1);

            // Legend 2
            let tform2 = "translate(20, 250)";

            if (["D", "F", "O", "Q", "R", "S", "U", "V"].includes(TSA))
                tform2 = "translate(20, 240)";

            if (["A", "D", "G", "H", "I", "M", "T", "Total"].includes(TSA))
                tform2 = "translate(20, 248)";

            if (["B", "P"].includes(TSA))
                tform2 = "translate(20, 254)";

            if (["C"].includes(TSA))
                tform2 = "translate(20, 255)";

            d3.select("#chart-case .stacked-bottom .legend")
                .transition()
                .duration(duration)
                .attr("transform", tform2);
        }

    </script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-26412009-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-26412009-1');
    </script>

</body>
</html>